name: Process Audio (YouTube/SoundCloud/MP3)

on:
  workflow_dispatch:
    inputs:
      source_type:
        description: 'Source type (youtube/soundcloud/mp3)'
        required: true
        type: choice
        options:
          - youtube
          - soundcloud
          - mp3
      source_url:
        description: 'URL (for YouTube/SoundCloud)'
        required: false
        type: string
      cookies_content:
        description: 'YouTube cookies (paste disini)'
        required: false
        type: string
      mp3_file_url:
        description: 'MP3 file URL (if source_type=mp3)'
        required: false
        type: string
      speed:
        description: 'Speed (0.5-5.0)'
        required: false
        default: '2.3'
        type: string
      amplify:
        description: 'Amplify dB (-20 to 20)'
        required: false
        default: '-4'
        type: string
      max_duration:
        description: 'Max Duration (seconds)'
        required: false
        default: '360'
        type: string
      job_id:
        description: 'Job ID from web'
        required: true
        type: string
      callback_url:
        description: 'Webhook callback URL'
        required: true
        type: string

jobs:
  process-audio:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # ===== SETUP FFMPEG (CACHED) =====
      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        id: setup-ffmpeg
        with:
          ffmpeg-version: release
      
      # ===== CACHE UNTUK yt-dlp =====
      - name: Cache yt-dlp
        id: cache-yt-dlp
        uses: actions/cache@v3
        with:
          path: /usr/local/bin/yt-dlp
          key: ${{ runner.os }}-yt-dlp-${{ hashFiles('**/yt-dlp-version.txt') }}
          restore-keys: |
            ${{ runner.os }}-yt-dlp-
      
      # ===== INSTALL yt-dlp (HANYA JIKA TIDAK DI CACHE) =====
      - name: Install yt-dlp
        if: steps.cache-yt-dlp.outputs.cache-hit != 'true' && inputs.source_type != 'mp3'
        run: |
          echo "Installing yt-dlp (not in cache)..."
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          /usr/local/bin/yt-dlp --version > yt-dlp-version.txt
      
      - name: Verify yt-dlp
        if: inputs.source_type != 'mp3'
        run: |
          echo "yt-dlp version:"
          /usr/local/bin/yt-dlp --version
      
      - name: Create temp directory
        run: mkdir -p temp
      
      # ===== SOURCE: YOUTUBE (DENGAN PERBAIKAN COOKIES) =====
      - name: Download from YouTube
        if: inputs.source_type == 'youtube'
        id: download_youtube
        env:
          COOKIES_CONTENT: ${{ inputs.cookies_content }}
          YOUTUBE_URL: ${{ inputs.source_url }}
        run: |
          cd temp
          
          echo "=== YOUTUBE DOWNLOAD DEBUG ==="
          echo "URL: $YOUTUBE_URL"
          
          # CEK COOKIES
          if [ -n "$COOKIES_CONTENT" ]; then
            echo "âœ… Cookies provided, length: ${#COOKIES_CONTENT} characters"
            
            # Simpan cookies ke file dengan format yang benar
            # Pastikan menggunakan line endings yang benar
            printf "%s\n" "$COOKIES_CONTENT" > cookies.txt
            
            # Tampilkan info file cookies
            echo "ðŸ“„ Cookies file info:"
            ls -la cookies.txt
            echo "ðŸ“ First 3 lines of cookies file:"
            head -3 cookies.txt
            echo "ðŸ“ Last 3 lines of cookies file:"
            tail -3 cookies.txt
            
            # Validasi format Netscape
            if grep -q "^# Netscape" cookies.txt; then
              echo "âœ… Cookies format: Netscape (valid)"
            else
              echo "âš ï¸ Warning: Cookies may not be in Netscape format"
            fi
            
            COOKIES_OPT="--cookies cookies.txt"
          else
            echo "âŒ No cookies provided"
            COOKIES_OPT=""
          fi
          
          echo "======================"
          
          # Download dengan yt-dlp (dengan verbose)
          echo "ðŸš€ Starting download..."
          yt-dlp $COOKIES_OPT \
            --verbose \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            --extract-audio \
            --audio-format mp3 \
            --audio-quality 0 \
            --output "%(title)s.%(ext)s" \
            "$YOUTUBE_URL" \
            --print-json > info.json 2> yt-dlp-error.log || {
              echo "âŒ yt-dlp failed with exit code $?"
              echo "=== ERROR LOG ==="
              cat yt-dlp-error.log
              echo "================"
              exit 1
            }
          
          echo "âœ… Download completed successfully"
          
          # Cek file hasil download
          MP3_FILES=$(ls *.mp3 2>/dev/null | wc -l)
          if [ "$MP3_FILES" -eq 0 ]; then
            echo "âŒ No MP3 files found after download"
            ls -la
            exit 1
          fi
          
          FILENAME=$(ls *.mp3 | head -1)
          echo "ðŸ“ Downloaded file: $FILENAME"
          
          # Parse JSON info
          if [ -f info.json ]; then
            TITLE=$(cat info.json | jq -r '.title' 2>/dev/null || echo "Unknown")
            DURATION=$(cat info.json | jq -r '.duration' 2>/dev/null || echo "0")
          else
            TITLE="Unknown"
            DURATION="0"
          fi
          
          echo "ðŸ“ Title: $TITLE"
          echo "â±ï¸ Duration: $DURATION seconds"
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "input_file=temp/$FILENAME" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== SOURCE: SOUNDCLOUD =====
      - name: Download from SoundCloud
        if: inputs.source_type == 'soundcloud'
        id: download_soundcloud
        run: |
          cd temp
          
          echo "Downloading from SoundCloud: ${{ inputs.source_url }}"
          
          yt-dlp \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -x --audio-format mp3 --audio-quality 0 \
            -o "%(title)s.%(ext)s" \
            "${{ inputs.source_url }}" \
            --print-json > info.json 2> yt-dlp-error.log || {
              echo "yt-dlp failed:"
              cat yt-dlp-error.log
              exit 1
            }
          
          FILENAME=$(ls *.mp3 | head -1)
          TITLE=$(cat info.json | jq -r '.title')
          DURATION=$(cat info.json | jq -r '.duration')
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "input_file=temp/$FILENAME" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== SOURCE: MP3 DIRECT =====
      - name: Download MP3 from URL
        if: inputs.source_type == 'mp3'
        id: download_mp3
        run: |
          cd temp
          
          echo "Downloading MP3 from: ${{ inputs.mp3_file_url }}"
          
          # Download MP3 from provided URL
          curl -L "${{ inputs.mp3_file_url }}" -o input.mp3 || {
            echo "Failed to download MP3"
            exit 1
          }
          
          # Check if file was downloaded
          if [ ! -f input.mp3 ]; then
            echo "No file downloaded"
            exit 1
          fi
          
          # Try to get title from URL or use filename
          FILENAME="input.mp3"
          TITLE=$(basename "${{ inputs.mp3_file_url }}" | sed 's/\.[^.]*$//')
          
          # Get duration with ffprobe
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input.mp3 2>/dev/null || echo "0")
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "input_file=temp/$FILENAME" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== PROCESS AUDIO (SAMA UNTUK SEMUA) =====
      - name: Process Audio with FFmpeg
        id: process
        run: |
          cd temp
          
          # Determine input file based on source
          if [ "${{ inputs.source_type }}" == "youtube" ]; then
            INPUT_FILE="${{ steps.download_youtube.outputs.filename }}"
          elif [ "${{ inputs.source_type }}" == "soundcloud" ]; then
            INPUT_FILE="${{ steps.download_soundcloud.outputs.filename }}"
          else
            INPUT_FILE="input.mp3"
          fi
          
          OUTPUT_FILE="processed_${{ inputs.job_id }}.mp3"
          
          echo "Processing: $INPUT_FILE â†’ $OUTPUT_FILE"
          echo "Settings: Speed=${{ inputs.speed }}, Amplify=${{ inputs.amplify }}dB, Max Duration=${{ inputs.max_duration }}s"
          
          # Speed filter (handle >2.0)
          SPEED="${{ inputs.speed }}"
          if (( $(echo "$SPEED > 2.0" | bc -l) )); then
            FILTERS=""
            REMAINING=$SPEED
            while (( $(echo "$REMAINING > 2.0" | bc -l) )); do
              FILTERS="${FILTERS}atempo=2.0,"
              REMAINING=$(echo "$REMAINING / 2.0" | bc -l)
            done
            FILTERS="${FILTERS}atempo=$REMAINING"
            SPEED_FILTER=$FILTERS
          else
            SPEED_FILTER="atempo=$SPEED"
          fi
          
          # Amplify in dB
          VOLUME=$(echo "e(l(10)*${{ inputs.amplify }}/20)" | bc -l)
          
          echo "FFmpeg filter: $SPEED_FILTER, volume=$VOLUME"
          
          # Process with FFmpeg
          ffmpeg -i "$INPUT_FILE" \
            -filter:a "$SPEED_FILTER,volume=$VOLUME" \
            -t ${{ inputs.max_duration }} \
            -c:a libmp3lame -b:a 128k \
            -y "$OUTPUT_FILE" 2> ffmpeg-error.log || {
              echo "FFmpeg failed:"
              cat ffmpeg-error.log
              exit 1
            }
          
          # Get duration of processed file
          NEW_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$OUTPUT_FILE")
          
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "new_duration=$NEW_DURATION" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== UPLOAD TO WEBHOOK =====
      - name: Upload to webhook
        run: |
          cd temp
          
          # Determine title based on source
          if [ "${{ inputs.source_type }}" == "youtube" ]; then
            TITLE="${{ steps.download_youtube.outputs.title }}"
          elif [ "${{ inputs.source_type }}" == "soundcloud" ]; then
            TITLE="${{ steps.download_soundcloud.outputs.title }}"
          else
            TITLE="${{ steps.download_mp3.outputs.title }}"
          fi
          
          echo "Uploading to webhook: ${{ inputs.callback_url }}"
          echo "Job ID: ${{ inputs.job_id }}"
          echo "Title: $TITLE"
          
          # Kirim file ke callback URL
          curl -X POST "${{ inputs.callback_url }}" \
            -F "job_id=${{ inputs.job_id }}" \
            -F "audio_file=@${{ steps.process.outputs.output_file }}" \
            -F "title=$TITLE" \
            -F "source_type=${{ inputs.source_type }}" \
            -F "duration=${{ steps.process.outputs.new_duration }}" \
            -F "settings_speed=${{ inputs.speed }}" \
            -F "settings_amplify=${{ inputs.amplify }}" \
            -F "settings_max_duration=${{ inputs.max_duration }}" || {
              echo "Failed to upload to webhook"
              exit 1
            }
          
          echo "âœ… Upload completed"
          cd ..
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            temp/yt-dlp-error.log
            temp/ffmpeg-error.log
            temp/cookies.txt
            temp/info.json
      
      - name: Cleanup
        if: always()
        run: rm -rf temp/*