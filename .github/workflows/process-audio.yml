name: Process Audio (TikTok/SoundCloud/MP3)

on:
  workflow_dispatch:
    inputs:
      source_type:
        description: 'Source type (tiktok/soundcloud/mp3)'
        required: true
        type: choice
        options:
          - tiktok
          - soundcloud
          - mp3
      url:
        description: 'URL (for TikTok/SoundCloud)'
        required: false
        type: string
      mp3_file_url:
        description: 'MP3 file URL (if source_type=mp3)'
        required: false
        type: string
      speed:
        description: 'Speed (0.5-5.0)'
        required: false
        default: '2.3'
        type: string
      amplify:
        description: 'Amplify dB (-20 to 20)'
        required: false
        default: '-4'
        type: string
      max_duration:
        description: 'Max Duration (seconds)'
        required: false
        default: '360'
        type: string
      job_id:
        description: 'Job ID from web'
        required: true
        type: string
      callback_url:
        description: 'Webhook callback URL'
        required: true
        type: string

jobs:
  process-audio:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ===== SETUP DEPENDENCIES =====
      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        id: setup-ffmpeg
      
      - name: Install yt-dlp
        if: inputs.source_type != 'mp3'
        run: |
          pip install yt-dlp
      
      - name: Create temp directory
        run: mkdir -p temp
      
      # ===== SOURCE: TIKTOK =====
      - name: Download from TikTok
        if: inputs.source_type == 'tiktok'
        id: download_tiktok
        run: |
          cd temp
          echo "ðŸš€ Downloading TikTok: ${{ inputs.url }}"
          
          # TikTok tidak perlu cookies
          yt-dlp --extract-audio \
            --audio-format mp3 \
            --audio-quality 0 \
            --output "%(title)s.%(ext)s" \
            "${{ inputs.url }}" \
            --print-json > info.json
          
          FILENAME=$(ls *.mp3 | head -1)
          TITLE=$(cat info.json | jq -r '.title')
          DURATION=$(cat info.json | jq -r '.duration')
          
          echo "âœ… Downloaded: $TITLE"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== SOURCE: SOUNDCLOUD =====
      - name: Download from SoundCloud
        if: inputs.source_type == 'soundcloud'
        id: download_soundcloud
        run: |
          cd temp
          echo "ðŸš€ Downloading SoundCloud: ${{ inputs.url }}"
          
          yt-dlp --extract-audio \
            --audio-format mp3 \
            --audio-quality 0 \
            --output "%(title)s.%(ext)s" \
            "${{ inputs.url }}" \
            --print-json > info.json
          
          FILENAME=$(ls *.mp3 | head -1)
          TITLE=$(cat info.json | jq -r '.title')
          DURATION=$(cat info.json | jq -r '.duration')
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== SOURCE: MP3 DIRECT =====
      - name: Download MP3 from URL
        if: inputs.source_type == 'mp3'
        id: download_mp3
        run: |
          cd temp
          echo "ðŸš€ Downloading MP3: ${{ inputs.mp3_file_url }}"
          
          curl -L "${{ inputs.mp3_file_url }}" -o input.mp3
          
          # Get duration with ffprobe
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input.mp3 2>/dev/null || echo "0")
          
          echo "filename=input.mp3" >> $GITHUB_OUTPUT
          echo "title=uploaded_audio" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== PROCESS AUDIO (SAMA UNTUK SEMUA) =====
      - name: Process Audio with FFmpeg
        id: process
        run: |
          cd temp
          
          # Tentukan file input
          if [ "${{ inputs.source_type }}" == "tiktok" ]; then
            INPUT_FILE="${{ steps.download_tiktok.outputs.filename }}"
            TITLE="${{ steps.download_tiktok.outputs.title }}"
          elif [ "${{ inputs.source_type }}" == "soundcloud" ]; then
            INPUT_FILE="${{ steps.download_soundcloud.outputs.filename }}"
            TITLE="${{ steps.download_soundcloud.outputs.title }}"
          else
            INPUT_FILE="input.mp3"
            TITLE="${{ steps.download_mp3.outputs.title }}"
          fi
          
          OUTPUT_FILE="processed_${{ inputs.job_id }}.mp3"
          
          echo "ðŸŽµ Processing: $INPUT_FILE â†’ $OUTPUT_FILE"
          echo "âš™ï¸ Settings: Speed=${{ inputs.speed }}, Amplify=${{ inputs.amplify }}dB, Max=${{ inputs.max_duration }}s"
          
          # Speed filter (handle >2.0)
          SPEED="${{ inputs.speed }}"
          if (( $(echo "$SPEED > 2.0" | bc -l) )); then
            FILTERS=""
            REMAINING=$SPEED
            while (( $(echo "$REMAINING > 2.0" | bc -l) )); do
              FILTERS="${FILTERS}atempo=2.0,"
              REMAINING=$(echo "$REMAINING / 2.0" | bc -l)
            done
            FILTERS="${FILTERS}atempo=$REMAINING"
            SPEED_FILTER=$FILTERS
          else
            SPEED_FILTER="atempo=$SPEED"
          fi
          
          # Amplify in dB
          VOLUME=$(echo "e(l(10)*${{ inputs.amplify }}/20)" | bc -l)
          
          # Process with FFmpeg
          ffmpeg -i "$INPUT_FILE" \
            -filter:a "$SPEED_FILTER,volume=$VOLUME" \
            -t ${{ inputs.max_duration }} \
            -c:a libmp3lame -b:a 128k \
            -y "$OUTPUT_FILE"
          
          NEW_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$OUTPUT_FILE")
          
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "new_duration=$NEW_DURATION" >> $GITHUB_OUTPUT
          cd ..
      
      # ===== UPLOAD TO WEBHOOK =====
      - name: Upload to webhook
        run: |
          cd temp
          
          # Tentukan title
          if [ "${{ inputs.source_type }}" == "tiktok" ]; then
            TITLE="${{ steps.download_tiktok.outputs.title }}"
          elif [ "${{ inputs.source_type }}" == "soundcloud" ]; then
            TITLE="${{ steps.download_soundcloud.outputs.title }}"
          else
            TITLE="MP3 Upload"
          fi
          
          echo "ðŸ“¤ Uploading to callback: ${{ inputs.callback_url }}"
          
          curl -X POST "${{ inputs.callback_url }}" \
            -F "job_id=${{ inputs.job_id }}" \
            -F "audio_file=@${{ steps.process.outputs.output_file }}" \
            -F "title=$TITLE" \
            -F "source_type=${{ inputs.source_type }}" \
            -F "duration=${{ steps.process.outputs.new_duration }}"
          
          cd ..
      
      - name: Cleanup
        if: always()
        run: rm -rf temp/*